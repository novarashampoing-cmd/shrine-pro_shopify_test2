{%- comment -%}
  Section: Vidéo Shrine Pro (style Impact)
{%- endcomment -%}

{%- assign is_full = section.settings.full_width -%}

<style>
  .kvv-wrap-{{ section.id }}{
    position: relative;
    isolation: isolate;
    overflow: hidden;
    {%- if is_full -%}
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      border-radius: 0;
      box-shadow: none;
    {%- else -%}
      width: min(100%, var(--page-width, 1200px));
      margin-inline: auto;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
    {%- endif -%}
    color: {{ section.settings.text_color }};
  }

  .kvv-media-{{ section.id }}{
    position: relative;
    width: 100%;
    background: #000;
  }
  .kvv-media-{{ section.id }}::before{
    content:"";
    display:block;
    width:100%;
    padding-top:56.25%; /* 16/9 */
  }

  .kvv-video, .kvv-iframe, .kvv-poster{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit: cover;
    border:0;
  }

  .kvv-overlay-{{ section.id }}{
    position:absolute; inset:0;
    background: rgba({{ section.settings.overlay_color.red }}, {{ section.settings.overlay_color.green }}, {{ section.settings.overlay_color.blue }}, {{ section.settings.overlay_opacity | divided_by: 100.0 }});
  }

  .kvv-center{
    position:absolute; inset:0;
    display:grid; place-items:center;
    text-align:center;
    padding:2rem;
    color: inherit;
  }
  .kvv-sub{ font-weight:600; margin-bottom:.5rem; }
  .kvv-h{ font-weight:800; margin:.5rem 0 1rem; }
  .kvv-rich p{ margin-bottom:.75rem; }
  .kvv-btn{
    display:inline-block;
    padding:.75rem 1.25rem;
    border-radius:999px;
    font-weight:600;
    text-decoration:none;
  }
  .kvv-btn.fill{ background: {{ section.settings.button_bg }}; color: {{ section.settings.button_text }}; }
  .kvv-btn.outline{ border:2px solid currentColor; color:inherit; }
</style>

<section class="kvv-wrap-{{ section.id }}">
  <div class="kvv-media-{{ section.id }}">
    {%- assign poster_image = section.settings.poster | default: section.settings.video.preview_image -%}

    {%- if section.settings.video != blank -%}
      {%- if section.settings.autoplay -%}
        {%- assign show_controls = false -%}
      {%- else -%}
        {%- assign show_controls = true -%}
      {%- endif -%}

      {{ section.settings.video | video_tag:
        playsinline: true,
        preload: 'metadata',
        muted: true,
        loop: section.settings.autoplay,
        autoplay: section.settings.autoplay,
        controls: show_controls,
        class: 'kvv-video',
        image_size: '800x'
      }}

      {%- unless section.settings.autoplay -%}
        {%- if poster_image != blank -%}
          {{ poster_image | image_url: width: poster_image.width | image_tag: class: 'kvv-poster', loading: 'lazy' }}
        {%- endif -%}
      {%- endunless -%}

    {%- elsif section.settings.external_video_url.type == 'youtube' -%}
      <iframe class="kvv-iframe" src="https://www.youtube.com/embed/{{ section.settings.external_video_url.id }}?playsinline=1&{% if section.settings.autoplay %}autoplay=1&mute=1&loop=1&controls=0&{% endif %}playlist={{ section.settings.external_video_url.id }}&rel=0&modestbranding=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    {%- elsif section.settings.external_video_url.type == 'vimeo' -%}
      <iframe class="kvv-iframe" src="https://player.vimeo.com/video/{{ section.settings.external_video_url.id }}?{% if section.settings.autoplay %}background=1&autoplay=1&muted=1&loop=1&{% endif %}title=0&byline=0&portrait=0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    {%- endif -%}

    <div class="kvv-overlay-{{ section.id }}"></div>

    {%- if section.blocks.size > 0 -%}
      <div class="kvv-center">
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'subheading' -%}
              <p class="kvv-sub">{{ block.settings.text }}</p>
            {%- when 'heading' -%}
              <p class="kvv-h {{ block.settings.heading_tag }}">{{ block.settings.text }}</p>
            {%- when 'richtext' -%}
              <div class="kvv-rich">{{ block.settings.content }}</div>
            {%- when 'button' -%}
              <a href="{{ block.settings.url }}" class="kvv-btn {{ block.settings.style }}">{{ block.settings.text }}</a>
          {%- endcase -%}
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>
</section>

{% schema %}
{
  "name": "Vidéo Shrine Pro",
  "settings": [
    { "type": "checkbox", "id": "full_width", "label": "Pleine largeur", "default": true },
    { "type": "checkbox", "id": "autoplay", "label": "Lecture automatique", "default": false },
    { "type": "video", "id": "video", "label": "Vidéo Shopify" },
    { "type": "video_url", "id": "external_video_url", "accept": ["youtube","vimeo"], "label": "URL externe" },
    { "type": "image_picker", "id": "poster", "label": "Image d’affiche" },
    { "type": "color", "id": "text_color", "label": "Couleur du texte", "default": "#ffffff" },
    { "type": "color", "id": "overlay_color", "label": "Couleur overlay", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Opacité overlay", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 30 },
    { "type": "color", "id": "button_bg", "label": "Fond bouton (fill)", "default": "#111111" },
    { "type": "color", "id": "button_text", "label": "Texte bouton (fill)", "default": "#ffffff" }
  ],
  "blocks": [
    { "type": "subheading", "name": "Sous-titre", "settings": [ { "type": "text", "id": "text", "label": "Texte" } ] },
    { "type": "heading", "name": "Titre", "settings": [ { "type": "text", "id": "text", "label": "Texte" }, { "type": "select", "id": "heading_tag", "label": "Style", "options": [ { "value": "h1","label": "H1" }, { "value": "h2","label": "H2" }, { "value": "h3","label": "H3" } ], "default": "h2" } ] },
    { "type": "richtext", "name": "Paragraphe", "settings": [ { "type": "richtext", "id": "content", "label": "Contenu" } ] },
    { "type": "button", "name": "Bouton", "settings": [ { "type": "text", "id": "text", "label": "Texte" }, { "type": "url", "id": "url", "label": "Lien" }, { "type": "select", "id": "style", "label": "Style", "options": [ { "value": "fill", "label": "Plein" }, { "value": "outline", "label": "Contour" } ], "default": "fill" } ] }
  ],
  "presets": [
    { "name": "Vidéo Shrine Pro" }
  ]
}
{% endschema %}
